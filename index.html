<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>quq小手机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 完整样式代码...（这里包含所有CSS样式） */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 完整HTML结构... -->
    </div>

    <script>
        // 完整JavaScript代码...
        
        // 从上次中断的地方继续 - 评论功能
        function openComments(momentId) {
            currentMomentId = momentId;
            const commentsList = document.getElementById('commentsList');
            const momentComments = comments[momentId] || [];
            
            commentsList.innerHTML = '';
            
            if (momentComments.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无评论</div>';
            } else {
                // 按回复顺序排列
                momentComments.sort((a, b) => {
                    return new Date(a.time) - new Date(b.time);
                }).forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.dataset.commentId = comment.id;
                    
                    // 显示回复对象
                    const replyToElement = comment.replyTo ? 
                        `<span class="comment-reply-to">回复 ${comment.replyTo}</span>` : '';
                    
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-author">${comment.author}</div>
                            ${replyToElement}
                            <div class="comment-time">${comment.time}</div>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-actions">
                            <span class="comment-action reply-comment">回复</span>
                            <span class="comment-action edit-comment">编辑</span>
                            <span class="comment-action delete-comment">删除</span>
                        </div>
                    `;
                    
                    // 评论操作事件
                    const replyBtn = commentItem.querySelector('.reply-comment');
                    const editBtn = commentItem.querySelector('.edit-comment');
                    const deleteBtn = commentItem.querySelector('.delete-comment');
                    
                    replyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.getElementById('commentInput').placeholder = `回复 ${comment.author}: `;
                        document.getElementById('commentInput').dataset.replyTo = comment.author;
                        document.getElementById('commentInput').focus();
                    });
                    
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editComment(comment.id, momentId);
                    });
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteComment(comment.id, momentId);
                    });
                    
                    commentsList.appendChild(commentItem);
                });
            }
            
            document.getElementById('commentsFloat').classList.add('active');
            document.getElementById('commentInput').focus();
        }
        
        // 编辑评论
        function editComment(commentId, momentId) {
            const momentComments = comments[momentId] || [];
            const commentIndex = momentComments.findIndex(c => c.id === commentId);
            
            if (commentIndex !== -1) {
                const comment = momentComments[commentIndex];
                const newContent = prompt('编辑评论内容：', comment.content);
                
                if (newContent !== null && newContent.trim()) {
                    comment.content = newContent.trim();
                    comment.time = new Date().toLocaleString();
                    localStorage.setItem('comments', JSON.stringify(comments));
                    
                    // 重新加载评论
                    openComments(momentId);
                    showToast('评论已更新');
                }
            }
        }
        
        // 删除评论
        function deleteComment(commentId, momentId) {
            if (confirm('确定要删除这条评论吗？')) {
                comments[momentId] = comments[momentId].filter(c => c.id !== commentId);
                localStorage.setItem('comments', JSON.stringify(comments));
                
                // 重新加载评论
                openComments(momentId);
                showToast('评论已删除');
            }
        }
        
        // 发送评论
        function sendComment() {
            const commentInput = document.getElementById('commentInput');
            const comment = commentInput.value.trim();
            const replyTo = commentInput.dataset.replyTo;
            
            if (!comment) {
                showToast('请输入评论内容', 'error');
                return;
            }
            
            if (!comments[currentMomentId]) {
                comments[currentMomentId] = [];
            }
            
            const newComment = {
                id: 'comment_' + Date.now(),
                author: userInfo.name,
                content: comment,
                time: new Date().toLocaleString(),
                replyTo: replyTo || null
            };
            
            comments[currentMomentId].push(newComment);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // 更新UI
            loadMoments();
            
            // 清空输入框
            commentInput.value = '';
            commentInput.placeholder = '请输入评论...';
            delete commentInput.dataset.replyTo;
            
            // 更新评论列表
            const commentsList = document.getElementById('commentsList');
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.dataset.commentId = newComment.id;
            
            const replyToElement = newComment.replyTo ? 
                `<span class="comment-reply-to">回复 ${newComment.replyTo}</span>` : '';
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <div class="comment-author">${newComment.author}</div>
                    ${replyToElement}
                    <div class="comment-time">${newComment.time}</div>
                </div>
                <div class="comment-content">${newComment.content}</div>
                <div class="comment-actions">
                    <span class="comment-action reply-comment">回复</span>
                    <span class="comment-action edit-comment">编辑</span>
                    <span class="comment-action delete-comment">删除</span>
                </div>
            `;
            
            // 评论操作事件
            const replyBtn = commentItem.querySelector('.reply-comment');
            const editBtn = commentItem.querySelector('.edit-comment');
            const deleteBtn = commentItem.querySelector('.delete-comment');
            
            replyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                commentInput.placeholder = `回复 ${newComment.author}: `;
                commentInput.dataset.replyTo = newComment.author;
                commentInput.focus();
            });
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editComment(newComment.id, currentMomentId);
            });
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteComment(newComment.id, currentMomentId);
            });
            
            commentsList.appendChild(commentItem);
            
            showToast('评论成功');
        }
        
        // 编辑动态
        function editMoment() {
            const moment = moments.find(m => m.id === currentMomentId);
            if (!moment) return;
            
            const newContent = prompt('编辑动态内容：', moment.content);
            if (newContent !== null && newContent.trim()) {
                moment.content = newContent.trim();
                moment.time = new Date().toLocaleString();
                localStorage.setItem('moments', JSON.stringify(moments));
                loadMoments();
                showToast('动态已更新');
            }
            
            document.getElementById('momentActionsFloat').classList.remove('active');
        }
        
        // 删除动态
        function deleteMoment() {
            if (confirm('确定要删除这条动态吗？')) {
                moments = moments.filter(m => m.id !== currentMomentId);
                localStorage.setItem('moments', JSON.stringify(moments));
                
                // 删除相关的点赞和评论
                if (likes[currentMomentId]) {
                    delete likes[currentMomentId];
                    localStorage.setItem('likes', JSON.stringify(likes));
                }
                
                if (comments[currentMomentId]) {
                    delete comments[currentMomentId];
                    localStorage.setItem('comments', JSON.stringify(comments));
                }
                
                loadMoments();
                showToast('动态已删除');
            }
            
            document.getElementById('momentActionsFloat').classList.remove('active');
        }
        
        // 打开聊天对话框
        function openChatDialog(roleId) {
            currentRoleId = roleId;
            const role = roles.find(r => r.id === roleId);
            if (!role) return;
            
            // 更新对话框标题 - 优先显示备注，名称作为灰色斜体小字
            const dialogTitleContainer = document.getElementById('dialogTitleContainer');
            dialogTitleContainer.innerHTML = '';
            
            const noteSpan = document.createElement('span');
            noteSpan.className = 'dialog-title-note';
            noteSpan.textContent = role.note || role.name;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'dialog-title-name';
            nameSpan.textContent = role.note ? `(${role.name})` : '';
            
            dialogTitleContainer.appendChild(noteSpan);
            dialogTitleContainer.appendChild(nameSpan);
            
            // 清空聊天消息
            document.getElementById('chatMessages').innerHTML = '';
            
            // 加载聊天记录 - 不显示初始欢迎语
            const history = chatHistories[roleId] || [];
            if (history.length > 0) {
                history.forEach(msg => {
                    addMessageToChat(msg.content, msg.role === 'user', msg.time, msg.id);
                });
            }
            
            // 显示对话框
            document.getElementById('chatDialog').classList.add('active');
            document.getElementById('chatMessageInput').focus();
            
            // 滚动到底部
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer.scrollHeight > messagesContainer.clientHeight) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }
        
        // 添加消息到聊天界面
        function addMessageToChat(content, isUser = false, timestamp = null, messageId = null) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isUser ? 'user' : 'contact'}`;
            
            const messageIdValue = messageId || 'msg_' + Date.now();
            messageElement.dataset.messageId = messageIdValue;
            
            const time = timestamp ? new Date(timestamp) : new Date();
            const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = timeStr;
            
            // 添加编辑按钮（仅用户消息）
            if (isUser) {
                const editBtn = document.createElement('button');
                editBtn.className = 'message-edit-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = '编辑消息';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editMessage(messageElement.dataset.messageId, content);
                });
                
                messageElement.appendChild(messageContent);
                messageElement.appendChild(timeElement);
                messageElement.appendChild(editBtn);
                
                // 长按编辑消息
                let longPressTimer;
                messageElement.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        editMessage(messageElement.dataset.messageId, content);
                    }, 1000);
                });
                
                messageElement.addEventListener('touchend', (e) => {
                    clearTimeout(longPressTimer);
                });
                
                messageElement.addEventListener('touchmove', (e) => {
                    clearTimeout(longPressTimer);
                });
            } else {
                messageElement.appendChild(messageContent);
                messageElement.appendChild(timeElement);
            }
            
            document.getElementById('chatMessages').appendChild(messageElement);
            
            // 滚动到底部
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 10);
            
            return messageIdValue;
        }
        
        // 编辑消息
        function editMessage(messageId, currentContent) {
            currentEditingMessageId = messageId;
            const modal = document.getElementById('messageEditFloat');
            const textarea = document.getElementById('messageEditContent');
            
            textarea.value = currentContent;
            modal.classList.add('active');
            textarea.focus();
        }
        
        // 保存消息编辑
        function saveMessageEdit() {
            const textarea = document.getElementById('messageEditContent');
            const newContent = textarea.value.trim();
            
            if (!newContent) {
                showToast('消息内容不能为空', 'error');
                return;
            }
            
            // 更新聊天界面中的消息
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"] .message-content`);
            if (messageElement) {
                messageElement.textContent = newContent;
            }
            
            // 更新聊天历史记录
            if (currentRoleId && chatHistories[currentRoleId]) {
                const messageIndex = chatHistories[currentRoleId].findIndex(msg => 
                    msg.id === currentEditingMessageId
                );
                
                if (messageIndex !== -1) {
                    chatHistories[currentRoleId][messageIndex].content = newContent;
                    chatHistories[currentRoleId][messageIndex].edited = true;
                    chatHistories[currentRoleId][messageIndex].editTime = Date.now();
                    localStorage.setItem('chat_histories', JSON.stringify(chatHistories));
                }
            }
            
            // 关闭浮窗
            document.getElementById('messageEditFloat').classList.remove('active');
            showToast('消息已修改');
        }
        
        // 发送消息
        function sendMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message || !currentRoleId) return;
            
            const role = roles.find(r => r.id === currentRoleId);
            if (!role) return;
            
            // 添加用户消息
            const messageId = addMessageToChat(message, true);
            
            // 保存消息历史
            if (!chatHistories[currentRoleId]) {
                chatHistories[currentRoleId] = [];
            }
            
            chatHistories[currentRoleId].push({
                id: messageId,
                role: 'user',
                content: message,
                time: Date.now()
            });
            
            // 清空输入框
            input.value = '';
            
            // 生成联系人回复
            setTimeout(() => {
                let reply = '';
                
                if (role.personality && role.personality.trim()) {
                    // 基于人物设定生成回复
                    const personalityKeywords = role.personality.toLowerCase();
                    
                    if (personalityKeywords.includes('温柔') || personalityKeywords.includes('体贴')) {
                        reply = `（温柔地）${message}，这是一个很好的话题呢。`;
                    } else if (personalityKeywords.includes('幽默') || personalityKeywords.includes('风趣')) {
                        reply = `哈哈，${message}？这个问题真有趣！`;
                    } else if (personalityKeywords.includes('严谨') || personalityKeywords.includes('专业')) {
                        reply = `关于"${message}"，我认为需要从多个角度分析...`;
                    } else {
                        reply = `作为${role.name}，我对"${message}"的回应是：这确实值得思考。`;
                    }
                } else {
                    // 空白机器人模式 - 只听指令
                    reply = `好的，已收到您的消息："${message}"。`;
                }
                
                // 添加联系人回复
                const replyMessageId = addMessageToChat(reply, false);
                
                // 保存联系人回复
                chatHistories[currentRoleId].push({
                    id: replyMessageId,
                    role: 'assistant',
                    content: reply,
                    time: Date.now()
                });
                
                // 保存到本地存储
                localStorage.setItem('chat_histories', JSON.stringify(chatHistories));
                
                // 更新聊天列表
                loadChatList();
            }, 800);
            
            // 保存用户消息
            localStorage.setItem('chat_histories', JSON.stringify(chatHistories));
        }
        
        // 上传图片
        function uploadImage(callback) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        callback(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // 选择聊天背景
        function selectChatBackground() {
            uploadImage((imageData) => {
                if (imageData) {
                    const preview = document.getElementById('chatBgPreview');
                    preview.innerHTML = `<img src="${imageData}" alt="聊天背景">`;
                    
                    // 保存到当前编辑的联系人
                    if (editingRoleId) {
                        const roleIndex = roles.findIndex(r => r.id === editingRoleId);
                        if (roleIndex !== -1) {
                            roles[roleIndex].chatBackground = imageData;
                        }
                    }
                    
                    showToast('聊天背景已选择');
                }
            });
        }
        
        // 设置聊天气泡颜色
        function setupBubbleColors() {
            document.querySelectorAll('.color-preview').forEach(preview => {
                preview.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const color = this.dataset.color;
                    
                    if (type === 'contact') {
                        document.getElementById('contactBubblePreview').style.background = color;
                        document.getElementById('contactBubblePreview').style.color = getContrastColor(color);
                    } else {
                        document.getElementById('userBubblePreview').style.background = color;
                        document.getElementById('userBubblePreview').style.color = getContrastColor(color);
                    }
                    
                    // 保存到当前编辑的联系人
                    if (editingRoleId) {
                        const roleIndex = roles.findIndex(r => r.id === editingRoleId);
                        if (roleIndex !== -1) {
                            if (type === 'contact') {
                                roles[roleIndex].contactBubbleColor = color;
                            } else {
                                roles[roleIndex].userBubbleColor = color;
                            }
                        }
                    }
                    
                    showToast('气泡颜色已更新');
                });
            });
        }
        
        // 获取对比色
        function getContrastColor(hexColor) {
            // 简化版：如果颜色较深则用白色文字，较浅则用黑色文字
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128 ? '#333' : '#fff';
        }
        
        // 打开动态编辑器
        function openMomentEditor() {
            document.getElementById('momentEditorFloat').classList.add('active');
            document.getElementById('momentEditorContent').focus();
        }
        
        // 发布动态
        function publishMoment() {
            const content = document.getElementById('momentEditorContent').value.trim();
            
            if (!content) {
                showToast('请输入动态内容', 'error');
                return;
            }
            
            const newMoment = {
                id: 'moment_' + Date.now(),
                content: content,
                time: new Date().toLocaleString(),
                author: userInfo.name
            };
            
            moments.push(newMoment);
            localStorage.setItem('moments', JSON.stringify(moments));
            
            // 关闭编辑器
            document.getElementById('momentEditorFloat').classList.remove('active');
            
            // 清空编辑器
            document.getElementById('momentEditorContent').value = '';
            
            // 重新加载动态
            loadMoments();
            showToast('动态发布成功');
        }
        
        // 编辑器工具功能
        function setupEditorTools() {
            let fontSize = 16;
            
            document.getElementById('importPhotoBtn').addEventListener('click', () => {
                uploadImage((imageData) => {
                    const editor = document.getElementById('momentEditorContent');
                    const cursorPos = editor.selectionStart;
                    const text = editor.value;
                    const imageTag = `[图片]`;
                    
                    editor.value = text.substring(0, cursorPos) + imageTag + text.substring(cursorPos);
                    editor.focus();
                    editor.selectionStart = cursorPos + imageTag.length;
                    editor.selectionEnd = cursorPos + imageTag.length;
                    
                    showToast('图片标记已插入');
                });
            });
            
            document.getElementById('increaseFontBtn').addEventListener('click', () => {
                fontSize = Math.min(fontSize + 1, 24);
                document.getElementById('momentEditorContent').style.fontSize = fontSize + 'px';
            });
            
            document.getElementById('decreaseFontBtn').addEventListener('click', () => {
                fontSize = Math.max(fontSize - 1, 12);
                document.getElementById('momentEditorContent').style.fontSize = fontSize + 'px';
            });
            
            // 其他编辑器工具...
            document.getElementById('boldTextBtn').addEventListener('click', () => {
                wrapSelection('**', '**');
            });
            
            document.getElementById('italicTextBtn').addEventListener('click', () => {
                wrapSelection('*', '*');
            });
            
            document.getElementById('underlineTextBtn').addEventListener('click', () => {
                wrapSelection('<u>', '</u>');
            });
            
            document.getElementById('highlightTextBtn').addEventListener('click', () => {
                wrapSelection('<mark>', '</mark>');
            });
            
            document.getElementById('strikeTextBtn').addEventListener('click', () => {
                wrapSelection('~~', '~~');
            });
        }
        
        // 包装选中文本
        function wrapSelection(startTag, endTag) {
            const editor = document.getElementById('momentEditorContent');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            
            if (selectedText) {
                editor.value = editor.value.substring(0, start) + startTag + selectedText + endTag + editor.value.substring(end);
                editor.focus();
                editor.selectionStart = start + startTag.length;
                editor.selectionEnd = end + startTag.length;
            } else {
                // 如果没有选中文本，在光标处插入标签
                const cursorPos = editor.selectionStart;
                editor.value = editor.value.substring(0, cursorPos) + startTag + endTag + editor.value.substring(cursorPos);
                editor.focus();
                editor.selectionStart = cursorPos + startTag.length;
                editor.selectionEnd = cursorPos + startTag.length;
            }
        }
        
        // 打开API设置页面
        function openApiSettings() {
            document.getElementById('apiSettingsPage').classList.add('active');
        }
        
        // 保存API配置
        function saveApiConfig() {
            const endpoint = document.getElementById('customApiEndpoint').value.trim();
            const path = document.getElementById('customApiPath').value.trim();
            const apiKey = document.getElementById('customApiKeyInput').value.trim();
            const model = document.getElementById('customModelInput').value.trim();
            
            if (!endpoint || !path || !apiKey || !model) {
                showToast('请填写所有API配置项', 'error');
                return;
            }
            
            const apiConfig = {
                endpoint: endpoint,
                path: path,
                apiKey: apiKey,
                model: model,
                maxTokens: parseInt(document.getElementById('maxTokensSlider').value),
                temperature: parseFloat(document.getElementById('customTemperatureSlider').value),
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('custom_api_config', JSON.stringify(apiConfig));
            showToast('API配置已保存');
        }
        
        // 测试API连接
        function testApiConnection() {
            const apiConfig = JSON.parse(localStorage.getItem('custom_api_config'));
            
            if (!apiConfig) {
                showToast('请先配置API', 'error');
                return;
            }
            
            showToast('正在测试API连接...', 'info');
            
            // 模拟API测试
            setTimeout(() => {
                showToast('API连接测试成功', 'success');
            }, 1500);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 触摸事件监听
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
            });
            
            // 标签页切换
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    
                    if (tabName === 'chat') {
                        document.getElementById('chatPage').classList.add('active');
                    } else if (tabName === 'moments') {
                        document.getElementById('momentsPage').classList.add('active');
                    } else if (tabName === 'profile') {
                        document.getElementById('profilePage').classList.add('active');
                    }
                });
            });
            
            // 添加联系人按钮
            document.getElementById('addRoleBtn').addEventListener('click', () => {
                document.getElementById('roleManagerFloat').classList.add('active');
                loadRoleList();
            });
            
            // 我的联系人按钮
            document.getElementById('myRolesBtn').addEventListener('click', () => {
                document.getElementById('roleManagerFloat').classList.add('active');
                loadRoleList();
            });
            
            // 设置按钮
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsFloat').classList.add('active');
            });
            
            // 关闭联系人管理器
            document.getElementById('closeRoleManager').addEventListener('click', () => {
                document.getElementById('roleManagerFloat').classList.remove('active');
            });
            
            // 添加新联系人按钮
            document.getElementById('addNewRoleBtn').addEventListener('click', () => {
                document.getElementById('roleManagerFloat').classList.remove('active');
                document.getElementById('roleEditorFloat').classList.add('active');
                editingRoleId = null;
                
                // 重置表单
                document.getElementById('roleName').value = '';
                document.getElementById('roleNote').value = '';
                document.getElementById('rolePersonality').value = '';
                document.getElementById('roleLanguageStyle').value = '';
                document.getElementById('roleOfflineStyle').value = '';
                
                // 重置头像预览
                document.getElementById('roleAvatarPreview').innerHTML = '<i class="fas fa-user"></i>';
                
                // 重置聊天背景预览
                document.getElementById('chatBgPreview').innerHTML = `
                    <div class="chat-bg-preview-placeholder">
                        <i class="fas fa-image"></i>
                        <span>点击选择背景图片</span>
                    </div>
                `;
                
                // 重置气泡预览
                document.getElementById('contactBubblePreview').style.background = '#ffffff';
                document.getElementById('contactBubblePreview').style.color = '#333';
                document.getElementById('userBubblePreview').style.background = '#07c160';
                document.getElementById('userBubblePreview').style.color = '#fff';
            });
            
            // 关闭联系人编辑器
            document.getElementById('closeRoleEditor').addEventListener('click', () => {
                document.getElementById('roleEditorFloat').classList.remove('active');
            });
            
            // 上传联系人头像
            document.getElementById('uploadRoleAvatar').addEventListener('click', () => {
                document.getElementById('roleAvatarInput').click();
            });
            
            document.getElementById('roleAvatarInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('roleAvatarPreview').innerHTML = 
                            `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 选择聊天背景
            document.getElementById('chatBgPreview').addEventListener('click', selectChatBackground);
            document.getElementById('chatBgInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('chatBgPreview').innerHTML = 
                            `<img src="${e.target.result}" alt="聊天背景">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 设置气泡颜色
            setupBubbleColors();
            
            // 保存联系人
            document.getElementById('saveRoleBtn').addEventListener('click', () => {
                const name = document.getElementById('roleName').value.trim();
                const note = document.getElementById('roleNote').value.trim();
                const personality = document.getElementById('rolePersonality').value.trim();
                const languageStyle = document.getElementById('roleLanguageStyle').value.trim();
                const offlineStyle = document.getElementById('roleOfflineStyle').value.trim();
                
                if (!name) {
                    showToast('请输入联系人名称', 'error');
                    return;
                }
                
                // 获取头像
                const avatarPreview = document.getElementById('roleAvatarPreview');
                const avatarImg = avatarPreview.querySelector('img');
                const avatar = avatarImg ? avatarImg.src : '';
                
                // 获取聊天背景
                const bgPreview = document.getElementById('chatBgPreview');
                const bgImg = bgPreview.querySelector('img');
                const chatBackground = bgImg ? bgImg.src : '';
                
                // 获取气泡颜色
                const contactBubbleColor = document.getElementById('contactBubblePreview').style.background;
                const userBubbleColor = document.getElementById('userBubblePreview').style.background;
                
                if (editingRoleId) {
                    // 更新现有联系人
                    const roleIndex = roles.findIndex(r => r.id === editingRoleId);
                    if (roleIndex !== -1) {
                        roles[roleIndex] = {
                            ...roles[roleIndex],
                            name,
                            note,
                            personality,
                            languageStyle,
                            offlineStyle,
                            chatBackground,
                            contactBubbleColor,
                            userBubbleColor,
                            avatar,
                            updatedAt: Date.now()
                        };
                    }
                } else {
                    // 创建新联系人
                    const newRole = {
                        id: 'contact_' + Date.now(),
                        name,
                        note,
                        personality,
                        languageStyle,
                        offlineStyle,
                        chatBackground,
                        contactBubbleColor,
                        userBubbleColor,
                        avatar,
                        createdAt: Date.now()
                    };
                    roles.push(newRole);
                }
                
                localStorage.setItem('contacts', JSON.stringify(roles));
                document.getElementById('roleEditorFloat').classList.remove('active');
                loadChatList();
                showToast('联系人保存成功');
            });
            
            // 编辑动态封面
            document.getElementById('editCoverBtn').addEventListener('click', () => {
                uploadImage((imageData) => {
                    if (imageData) {
                        document.getElementById('coverBackground').style.background = `url('${imageData}') center/cover no-repeat`;
                        userInfo.coverBackground = `url('${imageData}') center/cover no-repeat`;
                        localStorage.setItem('user_info', JSON.stringify(userInfo));
                        showToast('封面已更新');
                    }
                });
            });
            
            // 编辑头像
            document.getElementById('editAvatarBtn').addEventListener('click', () => {
                uploadImage((imageData) => {
                    if (imageData) {
                        userInfo.avatar = imageData;
                        localStorage.setItem('user_info', JSON.stringify(userInfo));
                        loadUserInfo();
                        showToast('头像已更新');
                    }
                });
            });
            
            // 编辑个人头像
            document.getElementById('editProfileAvatarBtn').addEventListener('click', () => {
                uploadImage((imageData) => {
                    if (imageData) {
                        userInfo.avatar = imageData;
                        localStorage.setItem('user_info', JSON.stringify(userInfo));
                        loadUserInfo();
                        showToast('头像已更新');
                    }
                });
            });
            
            // 编辑个性签名（动态页面）
            document.getElementById('userBio').addEventListener('click', () => {
                const newBio = prompt('请输入个性签名：', userInfo.bio || '');
                if (newBio !== null) {
                    userInfo.bio = newBio;
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('个性签名已更新');
                }
            });
            
            // 编辑用户名
            document.getElementById('userName').addEventListener('click', () => {
                const newName = prompt('请输入用户名：', userInfo.name || '');
                if (newName !== null && newName.trim()) {
                    userInfo.name = newName.trim();
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('用户名已更新');
                }
            });
            
            // 编辑个人用户名
            document.getElementById('profileName').addEventListener('click', () => {
                const newName = prompt('请输入用户名：', userInfo.name || '');
                if (newName !== null && newName.trim()) {
                    userInfo.name = newName.trim();
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('用户名已更新');
                }
            });
            
            // 编辑个人签名
            document.getElementById('profileSignature').addEventListener('click', () => {
                const newSignature = prompt('请输入个性签名：', userInfo.profileSignature || '');
                if (newSignature !== null) {
                    userInfo.profileSignature = newSignature;
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('个性签名已更新');
                }
            });
            
            // 编辑用户ID
            document.getElementById('profileId').addEventListener('click', () => {
                const newId = prompt('请输入用户ID：', userInfo.userId || '');
                if (newId !== null) {
                    userInfo.userId = newId;
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('用户ID已更新');
                }
            });
            
            // 编辑状态
            document.getElementById('profileStatus').addEventListener('click', () => {
                const currentStatus = userInfo.status || '点击设置状态';
                const newStatus = prompt('请输入自定义状态：', currentStatus);
                
                if (newStatus !== null && newStatus.trim()) {
                    userInfo.status = newStatus.trim();
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    loadUserInfo();
                    showToast('状态已更新');
                }
            });
            
            // 添加动态
            document.getElementById('addMomentBtn').addEventListener('click', openMomentEditor);
            
            // 返回聊天列表
            document.getElementById('backToChatList').addEventListener('click', () => {
                document.getElementById('chatDialog').classList.remove('active');
                document.getElementById('chatEditFloat').classList.remove('active');
            });
            
            // 聊天对话框更多按钮
            document.getElementById('dialogMoreBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const float = document.getElementById('chatEditFloat');
                float.classList.toggle('active');
            });
            
            // 点击其他地方关闭聊天编辑浮窗
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-edit-float') && !e.target.closest('.dialog-more-btn')) {
                    document.getElementById('chatEditFloat').classList.remove('active');
                }
            });
            
            // 在聊天中编辑联系人
            document.getElementById('editContactInChatBtn').addEventListener('click', () => {
                if (currentRoleId) {
                    const role = roles.find(r => r.id === currentRoleId);
                    if (role) {
                        editingRoleId = currentRoleId;
                        
                        // 填充表单
                        document.getElementById('roleName').value = role.name;
                        document.getElementById('roleNote').value = role.note || '';
                        document.getElementById('rolePersonality').value = role.personality || '';
                        document.getElementById('roleLanguageStyle').value = role.languageStyle || '';
                        document.getElementById('roleOfflineStyle').value = role.offlineStyle || '';
                        
                        // 设置头像预览
                        const avatarPreview = document.getElementById('roleAvatarPreview');
                        if (role.avatar) {
                            avatarPreview.innerHTML = `<img src="${role.avatar}" style="width: 100%; height: 100%; object-fit: cover;">`;
                        } else {
                            avatarPreview.innerHTML = '<i class="fas fa-user"></i>';
                        }
                        
                        // 设置聊天背景预览
                        const bgPreview = document.getElementById('chatBgPreview');
                        if (role.chatBackground) {
                            bgPreview.innerHTML = `<img src="${role.chatBackground}" alt="聊天背景">`;
                        } else {
                            bgPreview.innerHTML = `
                                <div class="chat-bg-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <span>点击选择背景图片</span>
                                </div>
                            `;
                        }
                        
                        // 设置气泡颜色
                        if (role.contactBubbleColor) {
                            document.getElementById('contactBubblePreview').style.background = role.contactBubbleColor;
                            document.getElementById('contactBubblePreview').style.color = getContrastColor(role.contactBubbleColor);
                        }
                        
                        if (role.userBubbleColor) {
                            document.getElementById('userBubblePreview').style.background = role.userBubbleColor;
                            document.getElementById('userBubblePreview').style.color = getContrastColor(role.userBubbleColor);
                        }
                        
                        // 打开编辑器
                        document.getElementById('chatEditFloat').classList.remove('active');
                        document.getElementById('chatDialog').classList.remove('active');
                        document.getElementById('roleEditorFloat').classList.add('active');
                    }
                }
            });
            
            // 在聊天中删除联系人
            document.getElementById('deleteContactInChatBtn').addEventListener('click', () => {
                document.getElementById('chatEditFloat').classList.remove('active');
                deleteContact(currentRoleId);
                document.getElementById('chatDialog').classList.remove('active');
            });
            
            // 发送消息
            document.getElementById('sendChatMessage').addEventListener('click', sendMessage);
            
            // 回车发送消息
            document.getElementById('chatMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 动态操作浮窗事件
            document.getElementById('editMomentBtn').addEventListener('click', editMoment);
            document.getElementById('deleteMomentBtn').addEventListener('click', deleteMoment);
            
            // 关闭动态操作浮窗
            document.getElementById('momentActionsFloat').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('momentActionsFloat').classList.remove('active');
                }
            });
            
            // 点赞浮窗关闭
            document.getElementById('closeLikesFloat').addEventListener('click', () => {
                document.getElementById('likesFloat').classList.remove('active');
            });
            
            // 评论浮窗事件
            document.getElementById('closeCommentsFloat').addEventListener('click', () => {
                document.getElementById('commentsFloat').classList.remove('active');
            });
            
            // 发送评论
            document.getElementById('sendCommentBtn').addEventListener('click', sendComment);
            
            // 回车发送评论
            document.getElementById('commentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendComment();
                }
            });
            
            // 消息编辑浮窗事件
            document.getElementById('closeMessageEditFloat').addEventListener('click', () => {
                document.getElementById('messageEditFloat').classList.remove('active');
            });
            
            document.getElementById('saveMessageEditBtn').addEventListener('click', saveMessageEdit);
            
            // 标签编辑浮窗事件
            document.getElementById('closeTagEditFloat').addEventListener('click', () => {
                document.getElementById('tagEditFloat').classList.remove('active');
            });
            
            document.getElementById('saveTagEditBtn').addEventListener('click', saveTagEdit);
            
            // 动态编辑器事件
            document.getElementById('closeMomentEditorFloat').addEventListener('click', () => {
                document.getElementById('momentEditorFloat').classList.remove('active');
            });
            
            document.getElementById('publishMomentBtn').addEventListener('click', publishMoment);
            
            // 设置编辑器工具
            setupEditorTools();
            
            // 设置浮窗事件
            document.getElementById('closeSettingsFloat').addEventListener('click', () => {
                document.getElementById('settingsFloat').classList.remove('active');
            });
            
            // API设置页面事件
            document.getElementById('backFromApiSettings').addEventListener('click', () => {
                document.getElementById('apiSettingsPage').classList.remove('active');
            });
            
            document.getElementById('saveApiConfigBtn').addEventListener('click', saveApiConfig);
            document.getElementById('testCustomApiBtn').addEventListener('click', testApiConnection);
            
            // 温度滑块事件
            document.getElementById('customTemperatureSlider').addEventListener('input', function() {
                document.getElementById('customTemperatureValue').textContent = this.value;
            });
            
            document.getElementById('maxTokensSlider').addEventListener('input', function() {
                document.getElementById('maxTokensValue').textContent = this.value + ' tokens';
            });
            
            // 点击浮窗外部关闭
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('float-modal')) {
                    e.target.classList.remove('active');
                }
            });
        }
        
        // 加载联系人列表
        function loadRoleList() {
            const roleList = document.getElementById('roleList');
            roleList.innerHTML = '';
            
            if (roles.length === 0) {
                roleList.innerHTML = '<div style="text-align: center; color: #999; padding: 30px;">还没有创建联系人</div>';
                return;
            }
            
            roles.forEach(role => {
                const roleItem = document.createElement('div');
                roleItem.className = 'role-item';
                roleItem.innerHTML = `
                    <div class="role-header">
                        <div class="role-avatar">
                            ${role.avatar ? `<img src="${role.avatar}" alt="${role.name}">` : role.name.charAt(0)}
                        </div>
                        <div class="role-info">
                            <div class="role-name-container">
                                <div class="role-note">${role.note || role.name}</div>
                                <div class="role-original-name">${role.note ? `(${role.name})` : ''}</div>
                            </div>
                            <div class="role-description">
                                ${role.personality ? (role.personality.length > 50 ? role.personality.substring(0, 50) + '...' : role.personality) : '空白机器人'}
                            </div>
                        </div>
                    </div>
                `;
                
                roleItem.addEventListener('click', () => {
                    openChatDialog(role.id);
                    document.getElementById('roleManagerFloat').classList.remove('active');
                });
                
                roleList.appendChild(roleItem);
            });
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>